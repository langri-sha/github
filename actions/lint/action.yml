name: Lint
description: |-
  Run lint checks in the workspace.

inputs:
  apply:
    description: |-
      Instead of running checks, apply changes.
    default: 'false'
  beachball:
    description: |-
      Check changes with Beachball.
    default: 'false'
  eslint:
    description: |-
      Check sources with ESLint.
    default: 'false'
  packages:
    description: |-
      Check packages are sorted and well-formed.
    default: 'false'
  prettier:
    description: |-
      Check sources with Prettier.
    default: 'false'
  typescript:
    description: |-
      Run TypeScript type checks.
    default: 'false'

runs:
  using: composite

  steps:
    - name: ESLint
      shell: bash
      if: fromJson(inputs.eslint)
      run: |
        pnpm eslint ${{ fromJson(inputs.apply) == 'true' && '--fix' || ''}} .

    - name: Prettier
      shell: bash
      if: fromJson(inputs.prettier)
      run: |
        pnpm prettier ${{ fromJson(inputs.apply) == 'true' && '--write' || '--check'}} .

    - name: TypeScript
      shell: bash
      if: fromJson(inputs.typescript) && !fromJson(inputs.apply)
      run: |
        pnpm tsc --build .

    - name: Beachball
      shell: bash
      if: fromJson(inputs.beachball) && github.event_name == 'pull_request'
      run: |
        if [[ '${{ fromJson(inputs.apply) }}' == 'true' ]]; then
          pnpm beachball change \
            --message '${{ github.event.pull_request.title }}' \
            --no-commit \
            --type patch \
            --yes
        else
          pnpm beachball check ||
          (
            echo "::error::Beachball changes detected. Run 'pnpm beachball change' and commit the changes.";
            exit 1
          )
        fi

    - name: Packages
      shell: bash
      if: fromJson(inputs.packages)
      run: |
        pnpx sort-package-json --check \
          ./apps/*/package.json \
          ./packages/*/package.json \
          package.json

    - name: Check packages
      shell: bash
      if: fromJson(inputs.packages) && !fromJson(inputs.apply)
      run: |
        pnpm -r exec npm pkg fix

        if [[ $(git status --porcelain) ]]; then
          echo '::error::Some packages need fixing.'
          git status
          git diff
          exit 1
        fi
